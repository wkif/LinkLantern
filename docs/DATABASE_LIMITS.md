# 数据库限制说明 - 背景图片上传

## ⚠️ 重要：数据库存储限制

在使用自定义背景功能时，您可能会遇到**数据库条目大小限制**的问题。本文档详细说明了这个限制以及如何避免。

## 📊 限制详情

### TiDB Cloud 数据库限制

您使用的 TiDB Cloud 数据库有以下限制：

- **最大条目大小**：6,291,456 字节（约 **6MB**）
- **这个限制是针对单条数据库记录的所有字段总和**

### Base64 编码影响

背景图片以 base64 格式存储，这会导致文件大小增加：

- **原始文件**：例如 5MB
- **Base64 编码后**：约 6.65MB（增加 33%）
- **结果**：超过数据库 6MB 限制 ❌

### 实际文件大小限制

为了安全起见，我们设置了以下限制：

```
原始文件限制：4MB
  ↓
Base64 编码后：约 5.3MB
  ↓
数据库存储：安全，不超过 6MB ✅
```

## 🚫 错误示例

如果您尝试上传过大的文件，会看到以下错误：

```
ConnectorError: entry too large, the max entry size is 6291456, 
the size of data is 6805201
```

这表示：
- 数据库限制：6,291,456 字节（6MB）
- 您的数据：6,805,201 字节（6.5MB）
- 结果：**超出限制 514KB**

## ✅ 解决方案

### 1. 压缩图片（推荐）

使用图片压缩工具可以在保持画质的同时大幅减小文件大小：

#### 在线工具（推荐）
- **[TinyPNG](https://tinypng.com/)** - 支持 PNG、JPG
  - 通常可以减小 70% 的文件大小
  - 肉眼几乎看不出质量差异
  
- **[Squoosh](https://squoosh.app/)** - Google 出品
  - 支持多种格式和高级选项
  - 可以实时预览压缩效果
  
- **[Compressor.io](https://compressor.io/)** - 强力压缩
  - 可以选择压缩级别
  - 支持批量处理

#### 本地工具
- **ImageOptim**（Mac）
- **FileOptimizer**（Windows）
- **GIMP**（跨平台）

### 2. 调整图片尺寸

如果图片分辨率过高：

```
原始：4K (3840x2160) → 10MB
  ↓ 缩小尺寸
优化：Full HD (1920x1080) → 2MB
  ↓ 压缩
最终：1920x1080 压缩版 → 0.8MB ✅
```

### 3. 选择合适的格式

不同格式有不同的压缩效果：

| 格式 | 适用场景 | 文件大小 | 画质 |
|------|---------|---------|------|
| **JPEG** | 照片、复杂图像 | 小 | 有损压缩 |
| **PNG** | 图标、简单图形 | 中 | 无损压缩 |
| **WebP** | 现代浏览器 | 很小 | 优秀 |
| **GIF** | 动画（不推荐作为背景） | 大 | 低 |

**推荐**：对于背景图片，使用 **JPEG 格式 + 80-90% 质量**，效果最佳。

## 📏 推荐配置

### 理想设置

```yaml
格式: JPEG
分辨率: 1920x1080 或 2560x1440
质量: 85%
文件大小: 1-2MB
```

### 可接受设置

```yaml
格式: PNG/WebP
分辨率: ≤ 3840x2160
质量: 根据需要
文件大小: ≤ 4MB
```

## 🛠️ 实际操作示例

### 使用 TinyPNG 压缩

1. 访问 https://tinypng.com/
2. 拖拽您的图片文件
3. 等待压缩完成
4. 下载压缩后的图片
5. 在 LinkLantern 中上传

**效果示例**：
- 原始文件：8.2MB
- 压缩后：2.1MB（减少 74%）
- 视觉差异：几乎无

### 使用 Squoosh 调整

1. 访问 https://squoosh.app/
2. 上传图片
3. 选择格式（推荐 MozJPEG）
4. 调整质量滑块到 80-85%
5. 查看预览（放大查看细节）
6. 下载优化后的图片

## 🔍 如何检查文件大小

### Mac
```bash
ls -lh your-image.jpg
# 或者在 Finder 中右键 → 显示简介
```

### Windows
```bash
dir your-image.jpg
# 或者在文件资源管理器中右键 → 属性
```

### 在线检查
- 上传到 https://www.metadata2go.com/file-info
- 查看详细文件信息

## 💡 开发建议

### 如果您是开发者

考虑以下优化方案：

1. **服务端压缩**
   ```typescript
   // 使用 sharp 库压缩图片
   import sharp from 'sharp'
   
   const compressedImage = await sharp(buffer)
     .jpeg({ quality: 85 })
     .resize(1920, 1080, { fit: 'inside' })
     .toBuffer()
   ```

2. **使用对象存储**
   - 阿里云 OSS
   - 腾讯云 COS
   - AWS S3
   - 七牛云
   
   这样可以绕过数据库大小限制。

3. **升级数据库**
   - 考虑升级到更高配置的 TiDB Cloud
   - 或迁移到其他支持更大条目的数据库

## ❓ 常见问题

### Q: 为什么不直接存储在文件系统？
A: base64 存储简化了架构，无需额外的文件服务器。对于个人使用完全够用。

### Q: 可以临时增加限制吗？
A: 这是 TiDB Cloud 的硬限制，无法修改。只能通过压缩图片或升级方案解决。

### Q: 为什么不用 URL 存储？
A: URL 存储需要图床服务，增加了复杂度和依赖。base64 是最简单的方案。

### Q: 压缩会损失画质吗？
A: 适度压缩（质量 80-90%）肉眼几乎看不出差异。过度压缩才会明显降低画质。

## 📞 需要帮助？

如果您仍然遇到问题：

1. 确保图片已经压缩到 4MB 以下
2. 检查文件格式是否支持
3. 尝试使用不同的压缩工具
4. 查看浏览器控制台的详细错误信息

---

**更新时间**: 2026-01-19  
**数据库**: TiDB Cloud  
**限制**: 6MB per entry

